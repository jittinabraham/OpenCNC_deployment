name: Helm Chart Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'config-service/**'
      - 'main-service/**'
      - 'tsn-service/**'
      - '.github/workflows/helm-validate.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'config-service/**'
      - 'main-service/**'
      - 'tsn-service/**'

jobs:
  helm-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint config-service chart
        run: |
          helm lint config-service/
          echo "✓ config-service chart linted successfully"

      - name: Lint main-service chart
        run: |
          helm lint main-service/
          echo "✓ main-service chart linted successfully"

      - name: Lint tsn-service chart
        run: |
          helm lint tsn-service/
          echo "✓ tsn-service chart linted successfully"

  helm-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Template config-service chart
        run: |
          helm template config-service config-service/ > /tmp/config-service-rendered.yaml
          echo "✓ config-service chart templated successfully"

      - name: Template main-service chart
        run: |
          helm template main-service main-service/ > /tmp/main-service-rendered.yaml
          echo "✓ main-service chart templated successfully"

      - name: Template tsn-service chart
        run: |
          helm template tsn-service tsn-service/ > /tmp/tsn-service-rendered.yaml
          echo "✓ tsn-service chart templated successfully"

  helm-dry-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry-run config-service chart
        run: |
          helm install config-service config-service/ --dry-run --debug
          echo "✓ config-service dry-run successful"

      - name: Dry-run main-service chart
        run: |
          helm install main-service main-service/ --dry-run --debug
          echo "✓ main-service dry-run successful"

      - name: Dry-run tsn-service chart
        run: |
          helm install tsn-service tsn-service/ --dry-run --debug
          echo "✓ tsn-service dry-run successful"

  image-accessibility:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check config-service image accessibility
        run: |
          IMAGE="ghcr.io/jittinabraham/opencnc_config-service/config-service:fe2fdf0b"
          echo "Checking image: $IMAGE"
          docker pull $IMAGE
          echo "✓ config-service image is accessible"

      - name: Check main-service image accessibility
        run: |
          IMAGE="ghcr.io/jittinabraham/opencnc_main-service/main-service:eeeae1ec"
          echo "Checking image: $IMAGE"
          docker pull $IMAGE
          echo "✓ main-service image is accessible"

      - name: Check tsn-service image accessibility
        run: |
          IMAGE="ghcr.io/jittinabraham/opencnc_tsn-service/tsn-service:73a286e9"
          echo "Checking image: $IMAGE"
          docker pull $IMAGE
          echo "✓ tsn-service image is accessible"

  all-checks-passed:
    needs: [helm-lint, helm-template, helm-dry-run, image-accessibility]
    runs-on: ubuntu-latest
    steps:
      - name: All validation checks passed
        run: echo "✓ All Helm charts and images are validated successfully!"
